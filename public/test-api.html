<!DOCTYPE html>
<html>
  <head>
    <title>Highcharts Real-time Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://js.pusher.com/8.0/pusher.min.js"></script>
    <style>
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #chart-container {
        width: 100%;
        height: 100%;
        min-height: 300px;
        max-width: 800px;
        margin: 0 auto;
        position: relative;
      }
      #error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,0,0,0.1);
        padding: 20px;
        border-radius: 8px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="chart-container">
      <div id="error-message"></div>
    </div>

    <script>
      const THEME_COLORS = {
        light: {
          background: "#ffffff",
          text: "#000000",
          grid: "#e6e6e6",
          tooltip: "#f7f7f7",
        },
        dark: {
          background: "#121212",
          text: "#ffffff",
          grid: "#333333",
          tooltip: "#2a2a2a",
        },
      };

      const VALUE_COLORS = {
        low: "#D32F2F",
        medium: "#FFCA28",
        high: "#388E3C",
      };

      const pusher = new Pusher("809e85ce5d8ffdc09f9d", {
        cluster: "us3",
      });

      const channel = pusher.subscribe("chart-updates");
      
      function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      function hideError() {
        document.getElementById('error-message').style.display = 'none';
      }

      function getColorForValue(value) {
        if (value <= 15) return VALUE_COLORS.low;
        if (value <= 45) return VALUE_COLORS.medium;
        return VALUE_COLORS.high;
      }

      function getThemeColors(mode) {
        return THEME_COLORS[mode] || THEME_COLORS.light;
      }

      function createChart(initialValues, mode) {
        hideError();
        const container = document.getElementById("chart-container");
        const theme = getThemeColors(mode);

        window.chart = Highcharts.chart(container, {
          chart: {
            type: "column",
            animation: false,
            backgroundColor: theme.background,
            style: { color: theme.text },
          },
          title: { text: null },
          xAxis: {
            categories: ["No Boost", "No Makedown", "Makedown"],
            labels: { style: { color: theme.text } },
            gridLineWidth: 0,
            lineColor: theme.grid,
            tickColor: theme.grid,
          },
          yAxis: {
            title: { text: null },
            labels: {
              format: "{value}%",
              style: { color: theme.text },
            },
            gridLineWidth: 1,
            gridLineColor: theme.grid,
            lineColor: theme.grid,
          },
          tooltip: {
            backgroundColor: theme.tooltip,
            style: { color: theme.text },
            borderWidth: 0,
          },
          plotOptions: {
            column: {
              animation: false,
              dataLabels: {
                enabled: true,
                format: "{y:.1f}%",
                style: { color: theme.text },
              },
            },
          },
          series: [{
            name: "Values",
            data: initialValues.map(value => ({
              y: value,
              color: getColorForValue(value)
            }))
          }]
        });
      }

      async function fetchWithRetry(retries = 3, baseDelay = 1000) {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch("/.netlify/functions/get-chart-values", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ type: "initial-load" })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            if (!data.success) throw new Error('API returned unsuccessful status');
            if (!data.values || !Array.isArray(data.values)) throw new Error('Invalid data format');
            
            hideError();
            return data;
          } catch (error) {
            console.error(`Attempt ${i + 1} failed:`, error);
            const delay = baseDelay * Math.pow(2, i);
            
            if (i < retries - 1) {
              showError(`Loading data... Retry ${i + 1} of ${retries}`);
              await new Promise(resolve => setTimeout(resolve, delay));
            } else {
              showError('Unable to load chart data. Please refresh the page.');
              throw error;
            }
          }
        }
      }

      async function init() {
        try {
          const { values, mode } = await fetchWithRetry();
          createChart(values, mode);

          channel.bind("value-update", function (data) {
            console.log("Pusher update received:", data);

            if (data.type === "update" && Array.isArray(data.values)) {
              const chartData = data.values.map(value => ({
                y: Number(value),
                color: getColorForValue(Number(value))
              }));

              chartData.forEach((point, index) => {
                window.chart.series[0].points[index].update(point, false);
              });

              if (data.mode) {
                const theme = getThemeColors(data.mode);
                window.chart.update({
                  chart: {
                    backgroundColor: theme.background,
                    style: { color: theme.text }
                  },
                  xAxis: {
                    labels: { style: { color: theme.text } },
                    lineColor: theme.grid,
                    tickColor: theme.grid
                  },
                  yAxis: {
                    labels: { style: { color: theme.text } },
                    gridLineColor: theme.grid,
                    lineColor: theme.grid
                  },
                  tooltip: {
                    backgroundColor: theme.tooltip,
                    style: { color: theme.text }
                  },
                  plotOptions: {
                    column: {
                      dataLabels: {
                        style: { color: theme.text }
                      }
                    }
                  }
                }, false);
              }

              window.chart.redraw(true);
            }
          });

          const resizeObserver = new ResizeObserver((entries) => {
            for (let entry of entries) {
              if (window.chart) {
                window.chart.setSize(
                  entry.contentRect.width,
                  entry.contentRect.height,
                  false
                );
              }
            }
          });

          resizeObserver.observe(container);
        } catch (error) {
          console.error('Failed to initialize chart:', error);
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>