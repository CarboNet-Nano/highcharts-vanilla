<!DOCTYPE html>
<html>
  <head>
    <title>Highcharts Real-time Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
    <style>
      #chart-container {
        opacity: 0;
        transition: opacity 0.3s ease-in;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
      }
      #chart-container.ready {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div id="chart-container">Loading chart...</div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const pusher = new Pusher("809e85ce5d8ffdc09f9d", {
        cluster: "us3",
      });

      const channel = pusher.subscribe("chart-updates");

      function initializeChart(initialData) {
        const { values, mode } = initialData;
        const container = document.getElementById("chart-container");
        
        const theme = {
          light: { background: "#ffffff", text: "#000000" },
          dark: { background: "#121212", text: "#ffffff" },
        }[mode];

        container.style.backgroundColor = theme.background;
        container.style.color = theme.text;
        document.documentElement.className = `theme-${mode}`;

        const chartInstance = Highcharts.chart(container, {
          chart: {
            type: "column",
            animation: false,
            height: container.clientHeight || 300,
            width: container.clientWidth || 400,
            backgroundColor: theme.background,
            style: { color: theme.text },
          },
          title: { text: null },
          xAxis: {
            categories: ["No Boost", "No Makedown", "Makedown"],
            labels: { style: { color: theme.text } },
            gridLineWidth: 0,
            lineColor: theme.text,
            tickColor: theme.text,
          },
          yAxis: {
            title: { text: "Percentage" },
            labels: {
              format: "{value}%",
              style: { color: theme.text },
            },
            gridLineWidth: 0,
            lineColor: theme.text,
            gridLineColor: theme.text,
          },
          plotOptions: {
            column: {
              animation: false,
              dataLabels: {
                enabled: true,
                format: "{y:.1f}%",
                style: { color: theme.text },
              },
            },
          },
          series: [
            {
              name: "Values",
              data: values.map((value) => ({
                y: value,
                color: getColorForValue(value),
              })),
            },
          ],
        });

        channel.bind("value-update", function (data) {
          if (data.type === "update") {
            if (data.values) {
              const chartData = data.values.map((value) => ({
                y: Number(value),
                color: getColorForValue(Number(value)),
              }));

              chartData.forEach((point, index) => {
                chartInstance.series[0].points[index].update(point, false);
              });

              chartInstance.redraw(true);
            }

            if (data.mode) {
              updateTheme(chartInstance, data.mode);
            }
          }
        });

        container.classList.add("ready");
        return chartInstance;
      }

      function getColorForValue(value) {
        if (value <= 15) return "#D32F2F";
        if (value <= 45) return "#FFCA28";
        return "#388E3C";
      }

      function updateTheme(chartInstance, mode) {
        const theme = {
          light: { background: "#ffffff", text: "#000000" },
          dark: { background: "#121212", text: "#ffffff" },
        }[mode];

        document.documentElement.className = `theme-${mode}`;
        
        chartInstance.update(
          {
            chart: {
              backgroundColor: theme.background,
              style: { color: theme.text },
            },
            xAxis: {
              labels: { style: { color: theme.text } },
              lineColor: theme.text,
              tickColor: theme.text,
            },
            yAxis: {
              labels: { style: { color: theme.text } },
              gridLineColor: theme.text,
              lineColor: theme.text,
            },
            plotOptions: {
              column: {
                dataLabels: {
                  style: { color: theme.text },
                },
              },
            },
          },
          true
        );
      }

      async function fetchInitialData() {
        try {
          const response = await fetch("/.netlify/functions/get-chart-values", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "initial-load",
            }),
          });

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Failed to fetch initial values:", error);
          return { values: [0, 0, 0], mode: 'light' };
        }
      }

      async function initializeApp() {
        const initialData = await fetchInitialData();
        initializeChart(initialData);
      }

      initializeApp();
    });
    </script>
  </body>
</html>
