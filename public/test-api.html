<!DOCTYPE html>
<html>
  <head>
    <title>Highcharts Real-time Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
    <style>
      #chart-container {
        opacity: 0;
        transition: opacity 0.3s ease-in;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
      }
      #chart-container.ready {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div id="chart-container">Loading chart...</div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const pusher = new Pusher("809e85ce5d8ffdc09f9d", {
          cluster: "us3",
        });

        const channel = pusher.subscribe("chart-updates");

        async function initializeApp() {
          try {
            const initialData = await fetchInitialData();
            initializeChart(initialData);
          } catch (error) {
            console.error("Chart initialization failed:", error);
            document.getElementById("chart-container").textContent =
              "Chart failed to load";
          }
        }

        async function fetchInitialData() {
          try {
            console.log("Initiating API call from test-api.html");
            const response = await fetch(
              "/.netlify/functions/get-chart-values",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  chartId: "test-chart",
                  no_boost: 35.10204081632654,
                  no_makedown: 58.642934371462474,
                  makedown: 82.93877551020408,
                  mode: "dark",
                  glide_source: "glide init",
                }),
              }
            );

            const data = await response.json();
            console.log("Received response from API:", data);
            return data;
          } catch (error) {
            console.error("Failed to fetch initial values:", error);
            return { values: [0, 0, 0], mode: "light" };
          }
        }

        function initializeChart(initialData) {
          const { values, mode } = initialData;
          const container = document.getElementById("chart-container");

          const theme = {
            light: { background: "#ffffff", text: "#000000" },
            dark: { background: "#121212", text: "#ffffff" },
          }[mode];

          container.style.backgroundColor = theme.background;
          container.style.color = theme.text;
          document.documentElement.className = `theme-${mode}`;

          const chartInstance = Highcharts.chart(container, {
            // Chart initialization code
          });

          container.classList.add("ready");
          return chartInstance;
        }

        function getColorForValue(value) {
          if (value <= 15) return "#D32F2F";
          if (value <= 45) return "#FFCA28";
          return "#388E3C";
        }

        function updateTheme(chartInstance, mode) {
          // Theme update logic
        }

        initializeApp();
      });
    </script>
  </body>
</html>
