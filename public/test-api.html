<!DOCTYPE html>
<html>
  <head>
    <title>Highcharts Real-time Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #chart-container {
        width: 100%;
        height: 100vh;
        min-height: 300px;
      }
      #status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-family: sans-serif;
        font-size: 12px;
      }
      .connected {
        background: #4caf50;
        color: white;
      }
      .disconnected {
        background: #f44336;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="chart-container"></div>
    <div id="status"></div>

    <script type="module">
      import { Chart } from "./chart.js";
      import { EventManager } from "./eventManager.js";

      let chartInstance;
      let ws;
      const statusDiv = document.getElementById("status");

      function showStatus(message, isConnected) {
        statusDiv.textContent = message;
        statusDiv.className = isConnected ? "connected" : "disconnected";
      }

      function connectWebSocket() {
        const wsUrl = `${
          window.location.protocol === "https:" ? "wss:" : "ws:"
        }//${window.location.host}/api/ws`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          showStatus("Connected", true);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.values) {
              chartInstance.updateChartValues(data.values);
            }
          } catch (error) {
            console.error("Error processing message:", error);
          }
        };

        ws.onclose = () => {
          showStatus("Disconnected - Reconnecting...", false);
          // Try to reconnect after 2 seconds
          setTimeout(connectWebSocket, 2000);
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          ws.close();
        };
      }

      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("chart-container");
        chartInstance = new Chart(container);
        const events = new EventManager(chartInstance);

        // Start WebSocket connection
        connectWebSocket();
      });
    </script>
  </body>
</html>
