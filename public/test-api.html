<!DOCTYPE html>
<html>
  <head>
    <title>Highcharts Real-time Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
      #chart-container {
        width: 100%;
        height: 100vh;
        max-width: 800px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div id="chart-container"></div>

    <script>
      const THEME_COLORS = {
        light: {
          background: "#ffffff",
          text: "#000000",
          grid: "#e6e6e6",
          tooltip: "#f7f7f7",
        },
        dark: {
          background: "#121212",
          text: "#ffffff",
          grid: "#333333",
          tooltip: "#2a2a2a",
        },
      };

      function getColorForValue(value) {
        if (value <= 15) return "#D32F2F";
        if (value <= 45) return "#FFCA28";
        return "#388E3C";
      }

      // Create initial empty chart
      function initializeChart(mode = "light") {
        const theme = THEME_COLORS[mode];
        const container = document.getElementById("chart-container");

        window.chart = Highcharts.chart(container, {
          chart: {
            type: "column",
            backgroundColor: theme.background,
            style: { color: theme.text },
          },
          title: { text: null },
          xAxis: {
            categories: ["No Boost", "No Makedown", "Makedown"],
            labels: { style: { color: theme.text } },
            gridLineWidth: 0,
            lineColor: theme.grid,
            tickColor: theme.grid,
          },
          yAxis: {
            title: { text: null },
            labels: {
              format: "{value}%",
              style: { color: theme.text },
            },
            gridLineWidth: 1,
            gridLineColor: theme.grid,
            lineColor: theme.grid,
          },
          tooltip: {
            backgroundColor: theme.tooltip,
            style: { color: theme.text },
            borderWidth: 0,
          },
          plotOptions: {
            column: {
              animation: true,
              dataLabels: {
                enabled: true,
                format: "{y:.1f}%",
                style: { color: theme.text },
              },
            },
          },
          series: [
            {
              name: "Values",
              data: [],
            },
          ],
        });

        new ResizeObserver((entries) => {
          if (window.chart) {
            window.chart.setSize(
              entries[0].contentRect.width,
              entries[0].contentRect.height,
              false
            );
          }
        }).observe(container);
      }

      // Update chart with data
      function updateChartData({ values, mode }) {
        const data = values.map((value) => ({
          y: value,
          color: getColorForValue(value),
        }));

        window.chart.series[0].setData(data, true);
      }

      // Initialize empty chart immediately
      initializeChart();

      // Load data
      fetch("/.netlify/functions/get-chart-values", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          json_column: JSON.stringify({
            chartId: "test-chart",
            no_boost: 35.10204081632654,
            no_makedown: 46.27901453609963,
            makedown: 78.6734693877551,
            mode: "dark",
            glide_source: "glide init",
          }),
        }),
      })
        .then((response) => response.json())
        .then(updateChartData)
        .catch(console.error);
    </script>
  </body>
</html>
