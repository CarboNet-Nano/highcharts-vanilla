<!DOCTYPE html>
<html>
  <head>
    <title>Chart API Test</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #chart-container {
        width: 100%;
        height: 70vh;
        min-height: 300px;
      }
      #controls {
        padding: 20px;
        text-align: center;
      }
      #status {
        margin-top: 10px;
        padding: 5px;
        min-height: 20px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .updating {
        color: #666;
      }
      #apiResponse {
        margin-top: 20px;
        padding: 10px;
        background: #f5f5f5;
        white-space: pre-wrap;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div id="chart-container"></div>
    <div id="controls">
      <div>
        <input type="text" id="value1" value="35" />
        <input type="text" id="value2" value="46" />
        <input type="text" id="value3" value="82" />
        <button onclick="updateValues()">Update Values</button>
      </div>
      <div id="status"></div>
      <div id="apiResponse"></div>
    </div>

    <script type="module">
      import { Chart } from "./chart.js";
      import { EventManager } from "./eventManager.js";

      let chartInstance;
      const API_URL =
        "https://ornate-sorbet-9b9982.netlify.app/.netlify/functions/update-chart-data";
      const statusDiv = document.getElementById("status");
      const responseDiv = document.getElementById("apiResponse");

      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = type;
      }

      function showResponse(data) {
        responseDiv.textContent = JSON.stringify(data, null, 2);
      }

      async function callAPI(values) {
        showStatus("Calling API...", "updating");
        try {
          const requestBody = JSON.stringify({
            chartId: "test-chart",
            values: values,
          });
          console.log("Sending:", requestBody);

          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: requestBody,
          });

          const textResponse = await response.text();
          console.log("Raw response:", textResponse);

          let data;
          try {
            data = JSON.parse(textResponse);
          } catch (parseError) {
            console.error("JSON Parse Error:", parseError);
            throw new Error(`Invalid JSON response: ${textResponse}`);
          }

          showResponse(data);

          if (!response.ok) {
            throw new Error(
              data.message || `API Error: ${response.statusText}`
            );
          }

          return data;
        } catch (error) {
          console.error("API Error:", error);
          showStatus(`Error: ${error.message}`, "error");
          throw error;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("chart-container");
        chartInstance = new Chart(container);
        const events = new EventManager(chartInstance);

        window.updateValues = async () => {
          try {
            const values = [
              parseFloat(document.getElementById("value1").value),
              parseFloat(document.getElementById("value2").value),
              parseFloat(document.getElementById("value3").value),
            ];

            const data = await callAPI(values);

            if (data.success) {
              chartInstance.updateChartValues(data.values);
              showStatus("Update successful", "success");
            }
          } catch (error) {
            console.error("Update failed:", error);
            showStatus(`Error: ${error.message}`, "error");
          }
        };
      });
    </script>
  </body>
</html>
